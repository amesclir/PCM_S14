---
title: "PCM_S14"
author: "Marcial Escudero"
date: "1/23/2024"
output: html_document
editor_options: 
  chunk_output_type: console
---

MODELOS DE EVOLUCIÓN CROMOSOMÁTICA

Evolución del Número Cromosómico: De ChromEvol a los Modelos Integrados

El primer acercamiento formal a la modelización de la evolución cromosómica se basa en modelos probabilísticos de procesos de nacimiento-muerte (birth-death), implementados originalmente en chromEvol y expandidos en su segunda versión (Mayrose et al., 2010; Glick & Mayrose, 2014). Recientemente, se ha publicado la versión 3.0 (Shafir et al., 2024/2025), que permite modelizar la heterogeneidad de tasas a lo largo de la filogenia y modelización conjunta de caracteres binarios y cromosomas.

Estos modelos se centran en dos procesos biológicos fundamentales:

    Disploidía: Cambios incrementales en el número de cromosomas (ascendente por fisión o descendente por fusión/translocaciones).

    Poliploidía: Duplicaciones completas del genoma (WGD - Whole Genome Duplication), ya sea por autopoliploidía o alopoliploidía.

Modelos de Correlación y Estados de caracter

Más allá de la reconstrucción simple del número cromosómico, han surgido herramientas que permiten explorar la causalidad y la correlación con otros rasgos biológicos:

    BiChrom (Zenil-Ferguson et al., 2017, 2018): Implementado en el paquete de R chromploid, permite la modelización conjunta de rasgos binarios (por ejemplo, hábito herbáceo vs. leñoso) y la evolución cromosómica, analizando si el rasgo influye en las tasas de poliploidización o disploidía.

    ChromoPlus (Blackmon et al., 2019): Incluido en el paquete diversitree, permite incluso modelar tasas de especiación y extinción asociadas a los estados de un carácter binario y su interacción con los cromosomas (modelos tipo SSE), como ocurre con los sistemas de determinación sexual o el impulso meiótico.

    Modelos Cladogenéticos: Es importante mencionar que software como RevBayes (a través de modelos propuestos por Freyman & Höhna, 2018) permiten distinguir entre cambios que ocurren a lo largo de las ramas (anagénesis) y cambios que ocurren específicamente durante los eventos de especiación (cladogénesis).

    Lectura Clave: Para profundizar en los parámetros específicos (tasas de ganancia, pérdida, duplicación y transiciones), es fundamental consultar el capítulo de Escudero et al. (2023). En él se detalla cómo configurar los modelos para que reflejen de forma realista la biología del grupo de estudio.


MODELIZACIÓN CONJUNTA DE CARACTERES BINARIOS Y CROMOSOMAS

Implementación avanzada: Modelos Correlacionados con ChromoPlus

A continuación, exploraremos el modelo ChromoPlus (Blackmon et al., 2019). Este enfoque es conceptualmente similar a BiChrom (Zenil-Ferguson et al., 2017, 2018), pero ofrece una implementación más versátil al estar integrado en el paquete diversitree.

La principal ventaja de ChromoPlus es que nos permite modelizar de forma conjunta y dependiente un carácter discreto binario y el número cromosómico. Esto es fundamental para probar hipótesis donde la biología del rasgo (o la geografía) puede estar alterando las tasas de poliploidía o disploidía.
Caso Práctico: Biogeografía y Cromosomas en Centaurium

Para poner en práctica este modelo, utilizaremos los datos de Maguilla et al. (2021) sobre el género Centaurium. El objetivo es reconstruir simultáneamente:

    La geografía: Categorizada como un rasgo binario (Áreas ancestrales vs. Áreas de nueva colonización/expansión).

    La evolución cromosómica: El número de cromosomas a lo largo de la filogenia.

Este análisis nos permitirá testar una hipótesis biológica fascinante: ¿Facilita la poliploidía la colonización de nuevas áreas o la expansión del rango geográfico? Al modelizar ambos procesos conjuntamente, podremos observar si las tasas de transición cromosómica difieren significativamente entre las regiones ancestrales y las de reciente expansión.

```{r}
# ==============================================================================
# Chromosome and Binary Trait Co-evolutionary Analysis (ChromoPlus)
# ==============================================================================
# This script models the joint evolution of chromosome numbers and a binary trait
# using the chromePlus extension for the diversitree package.
# Updated: Includes haploid conversion, range filtering, and tree pruning.

# --- 0. Setup and Dependencies ---
# if (!require("devtools")) install.packages("devtools")
# devtools::install_github('coleoguy/chromePlus', force = TRUE)

library(chromePlus)
library(diversitree)
library(phytools) # Required for tree pruning

# --- 1. Data Preparation and Transformation ---
cat("Loading and transforming data...\n")
mydata <- read.csv("./Centaurium input_AncestralAreas.csv")

# 1.1 Convert to haploid chromosome number (DCN to n)
mydata[,2] <- mydata[,2] / 2

# 1.2 Filter dataset by haploid range (keeping only n = 9 to 28)
mydata_filtered <- mydata[mydata[,2] >= 9 & mydata[,2] <= 28, ]
cat("Species kept after range filtering (n: 9-28):", nrow(mydata_filtered), "\n")

# --- 2. Tree Validation and Pruning ---
cat("Loading and pruning tree...\n")
mytree <- read.tree("./Centaurium.tree")

# 2.1 Identify and remove taxa in the tree that are NOT in our filtered dataset
taxa_to_drop <- mytree$tip.label[!(mytree$tip.label %in% mydata_filtered[,1])]
mytree_pruned <- drop.tip(mytree, taxa_to_drop)

# 2.2 Ensure the pruned tree is ultrametric (essential for ODE solvers)
if (!is.ultrametric(mytree_pruned)) {
  mytree_pruned <- force.ultrametric(mytree_pruned)
  cat("Tree was not ultrametric; fixed with force.ultrametric.\n")
}

# 2.3 Verify exact match between tree and filtered data
if(!all(mytree_pruned$tip.label %in% mydata_filtered[,1])) {
  stop("Final mismatch: Some tree tips do not have corresponding data.")
}
cat("Final tree tips:", length(mytree_pruned$tip.label), "\n")

# --- 3. State Matrix Construction ---
# Note: hyper=TRUE adds 'hyper-states' for unobserved rate variation
cat("Preparing state matrix...\n")
dat.mat2 <- datatoMatrix(x = mydata_filtered[, 1:3], 
                         range = c(9, 28), 
                         hyper = TRUE)
head(dat.mat2)
# --- 4. Likelihood Function Construction ---
# Model 0: The "Full" Saturated Model
# This is the raw mathematical foundation. It treats every chromosome number 
# as an independent state with its own transition rate.
# It is too complex for biological inference but necessary as a base for constraints.
cat("Constructing initial likelihood function (Model 0)...\n")
lik <- make.mkn(tree = mytree_pruned, 
                states = dat.mat2, 
                k = ncol(dat.mat2), 
                strict = FALSE, 
                control = list(method = "ode"))
lik

# --- 5. Model Constraining ---
# Model 1: Complex/Trait-Dependent Model
# HYPOTHESIS: Chromosome evolution rates (gain/loss) DEPEND on the binary trait (biogeography).
# It allows different rates for State 0 (Ancestral) and State 1 (Colonized).
# Parameters to estimate: gain0, loss0, gain1, loss1, etc.
cat("Constraining Model 1 (Complex/Trait-Dependent)...\n")
con.lik3 <- constrainMkn(data = dat.mat2,
                         lik = lik,
                         polyploidy = FALSE, # Assuming no Whole Genome Duplication
                         hyper = TRUE,      # Allowing hidden states to capture rate heterogeneity
                         constrain = list(drop.demi = FALSE,
                                          drop.poly = FALSE))
con.lik3

# Model 2: Simple/Trait-Independent Model (The Null Hypothesis)
# HYPOTHESIS: Chromosome evolution is INDEPENDENT of the binary trait.
# 'nometa = TRUE' forces all rates to be equal across biogeographical states (e.g., gain0 = gain1).
# This model tests if biogeography has NO effect on chromosomal dynamics.
cat("Constraining Model 2 (Simple/Trait-Independent)...\n")
con.lik4 <- constrainMkn(data = dat.mat2,
                         lik = lik,
                         constrain = list(nometa = TRUE))

# --- 6. Parameter Verification ---
cat("Free parameters in Complex Model:", length(argnames(con.lik3)), "\n")
cat("Free parameters in Simple Model:", length(argnames(con.lik4)), "\n")

# --- 7. Maximum Likelihood Estimation (MLE) ---
# Optimization using 'subplex' method
cat("Running MLE optimization for Model 3 (Complex)...\n")
con.fit3 <- find.mle(con.lik3, x.init = rep(0.1, length(argnames(con.lik3))), method = "subplex")

cat("Running MLE optimization for Model 4 (Simple)...\n")
con.fit4 <- find.mle(con.lik4, x.init = rep(0.1, length(argnames(con.lik4))), method = "subplex")

# --- 8. Model Comparison and Results ---
cat("\n--- Model Comparison (ANOVA) ---\n")

# Corrected anova call
model_comparison <- anova(con.fit3, simple = con.fit4)

# To make it more readable in the output:
rownames(model_comparison) <- c("Complex_Model", "Simple_Model")
print(model_comparison)

cat("\n--- Estimated Parameters (Model 3) ---\n")
print(con.fit3$par)

```



########################



BIBLIOGRAFÍA BÁSICA

Escudero, M., Maguilla, E., Márquez-Corro, J. I., Martín-Bravo, S., Mayrose, I., Shafir, A., ... & Zenil-Ferguson, R. (2023). Using ChromEvol to Determine the Mode of Chromosomal Evolution. In Plant Cytogenetics and Cytogenomics: Methods and Protocols (pp. 529-547). New York, NY: Springer US.

Shafir, A., Halabi, K., Baumer, E., & Mayrose, I. (2025). ChromEvol v. 3: modeling rate heterogeneity in chromosome number evolution. New Phytologist, 245(4), 1787-1800.

Glick, L., & Mayrose, I. (2014). ChromEvol: assessing the pattern of chromosome number evolution and the inference of polyploidy along a phylogeny. Molecular biology and evolution, 31(7), 1914-1922.

Mayrose, I., Barker, M. S., & Otto, S. P. (2010). Probabilistic models of chromosome number evolution and the inference of polyploidy. Systematic biology, 59(2), 132-144.

Shafir, A., Halabi, K., Escudero, M., & Mayrose, I. (2023). A non‐homogeneous model of chromosome‐number evolution to reveal shifts in the transition patterns across the phylogeny. New Phytologist, 238(4), 1733-1744.



BIBLIOGRAFÍA RECOMENDADA

Blackmon, H., Justison, J., Mayrose, I., & Goldberg, E. E. (2019). Meiotic drive shapes rates of karyotype evolution in mammals. Evolution, 73(3), 511-523.

Freyman, W. A., & Höhna, S. (2018). Cladogenetic and anagenetic models of chromosome number evolution: a Bayesian model averaging approach. Systematic biology, 67(2), 195-215.

Zenil-Ferguson, R., Ponciano, J. M., & Burleigh, J. G. (2017). Testing the association of phenotypes with polyploidy: An example using herbaceous and woody eudicots. Evolution, 71(5), 1138-1148.

Zenil‐Ferguson, R., Burleigh, J. G., & Ponciano, J. M. (2018). chromploid: An R package for chromosome number evolution across the plant tree of life. Applications in plant sciences, 6(3), e1037.


BIBLIOGRAFÍA CASOS DE ESTUDIO ADICIONALES

Tribble, C. M., Márquez‐Corro, J. I., May, M. R., Hipp, A. L., Escudero, M., & Zenil‐Ferguson, R. (2024). Macroevolutionary inference of complex modes of chromosomal speciation in a cosmopolitan plant lineage. New Phytologist, 245, 2350-2361.

Valdés-Florido, A., Tan, L., Maguilla, E., Simón-Porcar, V. I., Zhou, Y. H., Arroyo, J., & Escudero, M. (2023). Drivers of diversification in Linum (Linaceae) by means of chromosome evolution: correlations with biogeography, breeding system and habit. Annals of Botany, 132(5), 949-962.

Maguilla, E., Escudero, M., Jiménez-Lobato, V., Díaz-Lifante, Z., Andrés-Camacho, C., & Arroyo, J. (2021). Polyploidy expands the range of Centaurium (Gentianaceae). Frontiers in Plant Science, 12, 650551.


######################################################################
Elementos extras y avanzados:                                        
######################################################################

######################################################################
CHROMOEVOL 3.0

Resumen

Los cambios en el número de cromosomas son un importante impulsor de la evolución de las plantas, afectando la diversificación ecológica, la tolerancia al estrés y los fenotipos. ChromEvol es una herramienta de software ampliamente utilizada para descifrar patrones de cambio en el número de cromosomas a lo largo de una filogenia de interés.  El programa evalúa el ajuste de modelos alternativos a los datos, estima las tasas de transición de diferentes tipos de eventos e infiere el número esperado de eventos a lo largo de cada rama de la filogenia.

Shafir et al. (2024) ha desarrollado ChromEvol v.3, que presenta múltiples avances metodológicos novedosos que capturan la variación en las tasas de transición a lo largo de una filogenia. Esta versión permite mejor a los investigadores identificar cómo las tasas de disploidía y poliploidía cambian según el número de cromosomas en el genoma, con respecto a un rasgo discreto o en ciertos subclados de la filogenia.

En el artículo de publicación demuestran la aplicabilidad de los nuevos modelos en la filogenia de las Solanáceas. Sus análisis identifican cuatro regímenes de transición del número de cromosomas que caracterizan distintos clados de Solanáceas y demuestran una asociación entre la autocompatibilidad y la alteración de la dinámica de la evolución del número de cromosomas.

ChromEvol v.3, disponible en https://github.com/anatshafir1/chromevol, ofrece a los investigadores una herramienta más flexible, completa y precisa para investigar la evolución del número de cromosomas y los diversos procesos que lo afectan.


######################################################################

MODELIZACIÓN CONJUNTA DE TASAS DE DIVERSIFICACIÓN Y CROMOSOMAS

Finalmente vamos ajustar un modelo más complejo, el modelo ChromoSSE (Freyman & Hohna, 2018). En este caso calculamos tasas de evolución cromosomáticas en las ramas (anagenéticas), en los nodos (cladogenéticas) y una tasa de extinción global. Esto lo hacemos en el software RevBayes.
Puedes usar los archivos de entrada Centaurium.tree y CentauriumData.tsv. Puedes copiar toda la carpeta data (donde están dichos archivos) y el archivo de control del análisis ChromEvol_clado.Rev y pégalos en la carpeta donde tengas instalado RevBayes. 
Puedes ejecutar el software con el comando "singularity run --app rb RevBayes_Singularity_1.1.1.simg ChromEvol_clado.Rev" en caso de usar linux y tener la versión precompilada tipor singularity. En caso contario con el comando "./rb ChromEvol_clado.Rev".
Copia y pega los resultados en la carpeta de este proyecto y procedamos visualizar e interpretar los resultados.
(Recientemente se ha desarrollado el modelo ChromoHiSSE, es decir, una versión de ChromoSSE pero con estados ocultos; Tribble et al., 2023).

```{r}
#library(devtools)
#devtools::install_github("cmt2/RevGadgets", force = T)

library(RevGadgets)
### There are good tutorial to use RevGadgets
library(coda)
library(ggplot2)
library(ggtree)
library(grid)
library(gridExtra)

file <- "ChromEvol_clado_final.tree"
labs <- c("10" = "10", "11" = "11", "14" = "14", "15" = "15", "18" = "18", "19" = "19", "20" = "20", "21" = "21", "27" = "27", "28" = "28", "3" = "3", "4" = "4", "5" = "5", "6" = "6", "7" = "7", "8" = "8", "9" = "9")

dec_example <- processAncStates(file, labs)

#plotAncStatesPie(dec_example, cladogenetic = T, tip_labels_offset = 0.2,pie_colors = "default")

# You can see the states sampled in the analysis in the
# dec_example@state_labels vector. This may be different 
# from the `labs` vector you provided above if not all 
# possible states are included in the annotated tree.
dec_example@state_labels

# We are going to generate colors for these states using
# a color palette, but you could also specify a color per
# state manually. 

# Get the length of the dec_example$state_labels vector
# to know how many colors you need. 
ncol <- length(dec_example@state_labels)

# We use colorRampPalette() to generate a function that will
# expand the RevGadgets color palette (colFun) to the necessary
# number of colors, but you can use any colors you like as long 
# as each state_label has a color. 
colors <- colorRampPalette(colFun(12))(ncol)

# Name the color vector with your state labels and then order 
# it in the order you'd like the ranges to appear in your legend.
# Otherwise, they will appear alphabetically. 
names(colors) <- dec_example@state_labels
colors
# Plot the results with pies at nodes
pie <- plotAncStatesPie(t = dec_example,
                        # Include cladogenetic events
                        cladogenetic = TRUE, 
                        # Add text labels to the tip pie symbols
                        tip_labels_states = TRUE,
                        # Offset those text labels slightly
                        tip_labels_states_offset = .05,
                        # Pass in your named and ordered color vector
                        pie_colors = colors, 
                        # Offset the tip labels to make room for tip pies
                        tip_labels_offset = .2, 
                        # Move tip pies right slightly 
                        tip_pie_nudge_x = .07,
                        # Change the size of node and tip pies  
                        tip_pie_size = 0.8,
                        node_pie_size = 1.5) +
  # Move the legend 
  theme(legend.position = c(0.1, 0.75))
pie
#######Finally we well make a plot with the posterior probability proportional to the size of the cicles at the nodes
map <- plotAncStatesMAP(t = dec_example, 
                        # Include cladogenetic events
                        cladogenetic = T,
                        # Pass in the same color vector
                        node_color = colors,
                        # adjust tip labels 
                        tip_labels_offset = 0.1,
                        # increase tip states symbol size
                        tip_states_size = 3) +
  # adjust legend position and remove color guide
  theme(legend.position = c(0.2, 0.87)) + 
  guides(color = FALSE)
map
```

Visualizing the parameters

```{r}

# specify the input file
file <- "ChromEvol_clado_model.log"

# read the trace and discard burnin
trace_quant <- readTrace(path = file, burnin = 0.1)

# or read the trace _then_ discard burnin
trace_quant <- readTrace(path = file, burnin = 0)
trace_quant <- removeBurnin(trace = trace_quant, burnin = 0.1)

library(coda)
trace_quant_MCMC <- as.mcmc(trace_quant[[1]])
effectiveSize(trace_quant_MCMC)
traceplot(trace_quant_MCMC)
trace_quant
summarizeTrace(trace = trace_quant, vars =  c("clado_fission_pr","clado_fusion_pr","clado_polyploid_pr", "gamma", "delta", "rho"))

plotTrace(trace = trace_quant, vars = c("gamma", "delta", "rho"))[[1]]
plotTrace(trace = trace_quant, vars = c("clado_fission_pr","clado_fusion_pr","clado_polyploid_pr"))[[1]]
```


######################################################################

CHROMEVOL 2.0 (SOLO ESTÁN IMPLEMENTADOS LOS MODELOS MÁS SIMPLES)

Lo primero que haremos es correr en chromEvol 2.0 los modelos CONST_RATE, CONST_RATE_DEMI, CONST_RATE_DEMI_EST, CONST_RATE_NO_DUPL, LINEAR_RATE, LINEAR_RATE_DEMI, LINEAR_RATE_DEMI_EST, LINEAR_RATE_NO_DUPL, BASE_NUM y BASE_NUM_DUPL. 
Copia y pega los archivos de control de análisis de cada uno de los modelos (paramCONST_RATE, paramCONST_RATE_DEMI, paramCONST_RATE_DEMI_EST, paramCONST_RATE_NO_DUPL, paramLINEAR_RATE, paramLINEAR_RATE_DEMI, paramLINEAR_RATE_DEMI_EST, paramLINEAR_RATE_NO_DUPL,  paramBASE_NUM y paramBASE_NUM_DUPL) que hay en este proyecto de R en la carpeta donde tengas instalado chromEvol2.0. Pegalos junto con los archivos de Centaurium (archivo de conteos de cromosomas Centaurium.txt y archivo del árbol filogenético Centaurium.tree). Puede ejercutar cada uno de los modelos con la linea "chromEvol param_CONST_RATE". Y así con todos los modelos. (Esto es un poco parecido a lo que hacíamos con BAMM)
Una vez que tengas todos los resultados, pega la carpeta OUT en este proyecto de R.

Compara los valores de AIC de los 10 modelos para los cuales tenemos resultados. Verás que el mejor modelo es BASE_NUM_DUPL, y el segundo mejor modelo es CONST_RATE_DEMI_EST.

En primer lugar vamos representar el mejor modelo según la versión 1.0 de chromEvol (nuestro segundo mejor modelo).

```{r}
library(ape)
source("ChromEvol.R")
myChromEvol <- read.ce("./OUT/CONST_RATE_DEMI_EST/")
plot.anc(myChromEvol)

```

Y en segundo lugar el mejor modelo según la versión 2.0 de chromEvol.
```{r}

myChromEvol2 <- read.ce("./OUT/BASE_NUM_DUPL/")
plot.anc(myChromEvol2)

```

Compara y discute los resultados.
